<style>
.tile-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.subtile {
    flex: 1 1 30%;
    min-width: 250px;
    background: #f5f5f5;
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.subtile label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
}

.subtile input,
.subtile select {
    width: 100%;
    margin-bottom: 10px;
    padding: 5px;
    font-size: 1em;
    box-sizing: border-box;
}

.rooms-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.room-tile {
    flex: 1 1 150px;
    min-width: 150px;
    background: #fff;
    border-radius: 6px;
    padding: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.system-info {
    margin-top: 15px;
    background: #eaeaea;
    border-radius: 6px;
    padding: 10px;
}
</style>

<!-- Untertiles oben -->
<div class="top-tiles">
    <!-- Tile 1: Betriebsart -->
    <div class="top-tile" id="tile_mode">
        <label>Betriebsart</label>
        <select id="mode_select">
            <!--MODE_OPTIONS-->
        </select>
        <select id="mode_room_select">
            <!--FLOOR_ROOM_OPTIONS-->
        </select>
    </div>

    <!-- Tile 2: Ist-Temperatur -->
    <div class="top-tile" id="tile_temperature">
        <label>Ist-Temperatur</label>
        <input type="number" id="input_temp" value="<!--MAX_TEMP-->" />
        <select id="temp_room_select">
            <!--FLOOR_ROOM_OPTIONS-->
        </select>
    </div>

    <!-- Tile 3: Zieltemperatur -->
    <div class="top-tile" id="tile_target">
        <label>Zieltemperatur (h)</label>
        <input type="number" id="input_target_hours" value="1" />
        <select id="target_room_select">
            <!--FLOOR_ROOM_OPTIONS-->
        </select>
    </div>
</div>

<!-- Dynamische Raumtiles -->
<div class="room-tiles">
    <!--ROOM_TILES-->
</div>

<!-- Systeminformationen -->
<div class="system-info">
    <h3>System Info</h3>
    <!--SYS_INFO-->
</div>

<!-- Räume anzeigen -->
<div class="rooms-container" id="rooms-container">
    <!-- Dynamisch erzeugte Raumtiles -->
</div>

<!-- Systeminfos -->
<div class="system-info" id="system-info">
    <div><strong>Hardware:</strong> <span id="sys-hw">--</span></div>
    <div><strong>Software Datum:</strong> <span id="sys-swdate">--</span></div>
    <div><strong>Branch:</strong> <span id="sys-branch">--</span></div>
    <div><strong>OS:</strong> <span id="sys-os">--</span></div>
    <div><strong>Filesystem Build:</strong> <span id="sys-fbi">--</span></div>
    <div><strong>App kompatibel:</strong> <span id="sys-appcompat">--</span></div>
</div>

<script>
(function() {
    const roomsContainer = document.getElementById('rooms-container');

    function updateRooms(roomsData) {
        roomsContainer.innerHTML = '';
        roomsData.forEach(floor => {
            floor.raeume.forEach(room => {
                const div = document.createElement('div');
                div.className = 'room-tile';
                div.innerHTML = `
                    <strong>${room.name}</strong><br>
                    Ist-Temp: ${room.temperatur ?? '--'}°C<br>
                    Soll-Temp: ${room.solltemperatur ?? '--'}°C<br>
                    Luftfeuchte: ${room.luftfeuchte ?? '--'}%<br>
                    Betriebsart: ${room.betriebsart ?? '--'}<br>
                    ${room.remaining_time > 0 ? `Restzeit: ${Math.floor(room.remaining_time/60)}:${room.remaining_time % 60} Std` : ''}
                    ${room.perm_solltemperatur ? `<br>Perm Soll: ${room.perm_solltemperatur}` : ''}
                `;
                roomsContainer.appendChild(div);

                // Dropdowns aktualisieren
                ['select-room-mode','select-room-temp','select-room-target'].forEach(selId => {
                    const sel = document.getElementById(selId);
                    if (!Array.from(sel.options).some(o => o.value == room.id)) {
                        const opt = document.createElement('option');
                        opt.value = room.id;
                        opt.text = room.name;
                        sel.add(opt);
                    }
                });
            });
        });
    }

    function updateSystemInfo(info) {
        document.getElementById('sys-hw').textContent = info.hw ?? '--';
        document.getElementById('sys-swdate').textContent = info['sw-date'] ?? '--';
        document.getElementById('sys-branch').textContent = info.branch ?? '--';
        document.getElementById('sys-os').textContent = info.os ?? '--';
        document.getElementById('sys-fbi').textContent = info.fbi ?? '--';
        document.getElementById('sys-appcompat').textContent = info['app-compatibility'] ? 'Ja' : 'Nein';
    }

    // Placeholder: initial befüllen
    updateRooms([]);
    updateSystemInfo({});

    // Exportieren für das Modul, das die Daten aktualisiert
    window.UpdateCentralControlTile = function(data) {
        if (data.rooms) updateRooms(data.rooms);
        if (data.systemInfo) updateSystemInfo(data.systemInfo);
    }
})();
</script>
